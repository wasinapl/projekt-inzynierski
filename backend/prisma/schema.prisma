datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

enum Role {
  USER
  ADMIN
}

enum DocumentStatus {
  CREATED
  PROCESSING
  FAILED
  READY
}

enum DocumentPartStatus {
  CREATED
  PROCESSING
  FAILED
  READY
}

model User {
  id           Int            @id @default(autoincrement())
  email        String         @unique
  name         String?
  password     String
  role         Role           @default(USER)
  Document     Document[]
  DocumentsSet DocumentsSet[]
}

model DocumentsSet {
  id         Int          @id @default(autoincrement())
  code       String       @unique
  name       String
  userId     Int?
  User       User?        @relation(fields: [userId], references: [id], onDelete: Cascade)
  documents  Document[]   @relation()
  ChatThread ChatThread[]
  createdAt  DateTime     @default(now())
  updatedAt  DateTime     @updatedAt
}

model Document {
  id             Int            @id @default(autoincrement())
  code           String         @unique
  title          String
  content        String
  documentsSetId Int
  documentsSet   DocumentsSet   @relation(fields: [documentsSetId], references: [id], onDelete: Cascade)
  userId         Int
  User           User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  DocumentPart   DocumentPart[]

  createdAt DateTime       @default(now())
  updatedAt DateTime       @updatedAt
  Status    DocumentStatus @default(CREATED)
}

model DocumentPart {
  id                    Int                    @id @default(autoincrement())
  content               String
  documentId            Int
  Document              Document               @relation(fields: [documentId], references: [id], onDelete: Cascade)
  DocumentPartEmbedding DocumentPartEmbedding?
}

model DocumentPartEmbedding {
  id             Int          @id @default(autoincrement())
  documentPartId Int          @unique
  documentPart   DocumentPart @relation(fields: [documentPartId], references: [id], onDelete: Cascade)
  vector         Json
}

model ChatThread {
  id            Int          @id @default(autoincrement())
  code          String       @unique
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt
  messages      Message[]
  documentSetId Int
  DocumentSet   DocumentsSet @relation(fields: [documentSetId], references: [id], onDelete: Cascade)
}

model Message {
  id           Int        @id @default(autoincrement())
  content      String
  createdAt    DateTime   @default(now())
  chatThreadId Int
  ChatThread   ChatThread @relation(fields: [chatThreadId], references: [id], onDelete: Cascade)
}
